<script src="https://cdn.jsdelivr.net/npm/@simonwep/selection-js/dist/selection.min.js"></script>
<style>
  .selected {
    color: red
  }
</style>
<small>[<a target="_parent" href="/#paahakemisto">to index</a>]</small>
<h1>{{ title }}</h1>

{{ loc[0] }} &mdash; {{ loc[1] }}<br/>
{{ year }}&ensp;{{ col }} 

<h2>Metadata</h2>
<table>
  {% for key, val in meta.items() %}
  <tr>
    <td align="right" width="50"><b>{{ key }}&ensp;</b></td>
    <td width="350">{{ val }}</td></tr>
  {% endfor %}
</table>

<h2>Themes</h2>
<ul>
{% for f_id, t_id, f, t in topics %}
<li><a target="_parent" href="/#{{f_id}}">{{ f }}</a> &mdash; <a target="_parent" href="/#{{t_id}}">{{ t }}</a></li>
{% endfor %}
</ul>

<h2>Similar poems</h2>
<table style="user-select: none">
{% for sp in sim_poems %}
  <tr>
    <td align="right">
    <a href="/poemdiff?nro1={{ nro }}&nro2={{ sp[0] }}">{{ sp[1] }}</a>
      &ensp;
    </td>
    <td>
      <img src="/static/img/blue.png" width="{{ (sp[5]*300) | int }}" height="10">
      &ensp;<small>{{ (sp[5]*100) | int }} %&emsp;</small>
    </td>
    <td>
      <small>{{ sp[3] }}</small>
    </td>
    <td>
      <small>{{ sp[2] }}</small>
    </td>
    <td>
      <small>{{ sp[4] }}</small>
    </td>
  </tr>
  {% endfor %}
</table>

<h2>Text</h2>
<table cellspacing="0" cellpadding="2">
  {% for v in verses %}
  <tr>
    {% if v[4] == "V" %}
      <td bgcolor="{{ v[3] }}" align="right" width="19">
        <a name="{{ v[0] }}" href="/verse?id={{ v[1] }}">
          <img src="/static/img/transparent.png" width="15" height="15" title="{{ v[2] }} similar" alt="{{ v[2] }}">
        </a>
      </td>
      <td align="right" width="35">&ensp;<sup><small>{{ v[0] }}</a></small></sup></td>
      <td width="350" class="verse" id="{{ v[0] }}">
      {% if v[0] in hl %}
        <b>{{ v[5] }}</b>
      {% else %}
        {{ v[5] }}
      {% endif %}</td>
    {% else %}
      {% if v[4] == "L" %}
      <td><a name="{{ v[0] }}" href="/verse?id={{ v[1] }}"></a></td>
      <td></td><td><small><i>{{ v[5] }}</i></small></td>
      {% elif v[4] == "K" %}
      <td><a name="{{ v[0] }}" href="/verse?id={{ v[1] }}"></a></td>
      <td></td><td><small>{{ v[5] }}</small></td>
      {% elif v[4] == "CPT" %}
      <td colspan="3" align="center">
        <a name="{{ v[0] }}" href="/verse?id={{ v[1] }}"></a>
        <h4>{{ v[5] }}</h4>
      </td>
      {% endif %}
    {% endif %}
  </tr>
  {% endfor %}
  <tr><td colspan="3"><hr/></td></tr>
  <tr><td colspan="3">
    <small>
    {% for r in refs %}
    {{ r }}<br/>
    {% endfor %}
    </small>
  </td></tr>
</table>
<script lang="javascript">
  const ds = new Selection({
    selectables: '.verse'
  })
  ds.on('move', ({ changed: { removed, added } }) => {
      for (const el of added)
        el.classList.add('selected')
      for (const el of removed)
        el.classList.remove('selected')
    })
  ds.on('stop', ({inst,selected}) => {
    inst.clearSelection()
    window.open('/passage?nro={{ nro }}&start=' + selected[0].id + '&end=' + selected[selected.length - 1].id,'_self')
  })
</script>

