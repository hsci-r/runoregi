<html>
<head>
<title>{{ data['poem'].smd.title }} â€” Runoregi</title>
<script src="https://cdn.jsdelivr.net/npm/@simonwep/selection-js/dist/selection.min.js"></script>
<style>
  .selected {
    background-color: #FFEEAA
  }
  .cn, .c0, .c1, .c2, .c3, .c4, .c5, .c6, .c7, .c8, .c9, .c10, .c11, .c12 {
      text-decoration: none
  }
  .c0 { background-color: rgb(235, 172, 35) }
  .c1 { background-color: rgb(184, 0, 88) }
  .c2 { background-color: rgb(0, 140, 249) }
  .c3 { background-color: rgb(0, 110, 0) }
  .c4 { background-color: rgb(0, 187, 173) }
  .c5 { background-color: rgb(209, 99, 230) }
  .c6 { background-color: rgb(178, 69, 2) }
  .c7 { background-color: rgb(255, 146, 135) }
  .c8 { background-color: rgb(89, 84, 214) }
  .c9 { background-color: rgb(0, 198, 248) }
  .c10 { background-color: rgb(135, 133, 0) }
  .c11 { background-color: rgb(0, 167, 108) }
  .c12 { background-color: rgb(189, 189, 189) }
  .g0 { background-color: #DDDDDD }
  .g1 { background-color: #AAAAAA }
</style>
</head>

<body>
[<a target="_parent" href="/">to index</a>]
<h1>{{ data['poem'].smd.title }}</h1>

<small>{{ data['poem'].nro }}</small><br/>
{{ data['poem'].smd.location }}<br/>
{{ data['poem'].smd.year }}&ensp;{{ data['poem'].smd.collector }}

{% if data['poem'].duplicates %}
<p>
<b>Duplicates:</b>
{% for nro in data['poem'].duplicates %}
<a href="/poem?nro={{ nro }}">{{ data['related'][nro].smd.title }}</a>
{% endfor %}
</p>
{% endif %}
{% if data['poem'].parents %}
<p>
<b>Duplicate of:</b>
{% for nro in data['poem'].parents %}
<a href="/poem?nro={{ nro }}">{{ data['related'][nro].smd.title }}</a>
{% endfor %}
</p>
{% endif %}

<h2>Metadata</h2>
<table>
  {% for key, val in data['poem'].meta.items() %}
  <tr>
    <td align="right" width="50"><b>{{ key }}&ensp;</b></td>
    <td width="350">{{ val }}</td></tr>
  {% endfor %}
</table>

<h2>Themes</h2>
{% for line in data['poem'].type_tree %}
{% if line.is_minor %}<font color="gray">{% endif %}{{ line.prefix | join('\u2003') }} {% if line.is_minor %}<small>{% endif %}<a href="/theme?id={{ line.type_id }}">{{ data['types'][line.type_id].name }}</a>{% if line.is_minor %}</small></font>{% endif %}<br/>
{% endfor %}

{% if data['sim'] %}
<h2>Similar poems</h2>
<p><small>[<a href="/multidiff?nro={{ data['poem'].nro }},{{ data['sim'] | map(attribute=0) | join(',') }}">compare all</a>]
[<a href="/poemnet?nro={{ data['poem'].nro }}">network view</a>]
{% if data['poem'].p_clust_id is not none and data['poem'].p_clust_size > 1 %}
[<a href="/dendrogram?source=cluster&nro={{ data['poem'].nro }}">cluster #{{ data['poem'].p_clust_id }} ({{ data['poem'].p_clust_size }} poems)</a>]
{% endif %}
</small></p>
{% endif %}

<table>
{% for nro, s in data['sim'] | sort(attribute=1, reverse=True) %}
  <tr>
    <td align="right" class="poem_id">
    <a href="/poemdiff?nro1={{ data['poem'].nro }}&nro2={{ nro }}">{{ data['related'][nro].smd.title }}</a>
      &ensp;
    </td>
    <td>
      <img src="/static/img/blue.png" width="{{ (s*300) | int }}" height="10">
      &ensp;<small>{{ (s*100) | int }} %&emsp;</small>
    </td>
    <td>
      <small>{{ data['related'][nro].smd.year }}</small>
    </td>
    <td>
      <small>{{ data['related'][nro].smd.location }}</small>
    </td>
    <td>
      <small>{{ data['related'][nro].smd.collector }}</small>
    </td>
  </tr>
  {% endfor %}
</table>

{% if data['sim_right'] %}
<h2>Contains poems</h2>
<p><small>[<a href="/multidiff?nro={{ data['poem'].nro }},{{ data['sim_right'] | map(attribute=0) | join(',') }}">compare all</a>]</small></p>
{% endif %}

<table style="user-select: none">
{% for nro, s in data['sim_right'] | sort(attribute=1, reverse=True) %}
  <tr>
    <td align="right" class="poem_id">
    <a href="/poemdiff?nro1={{ data['poem'].nro }}&nro2={{ nro }}">{{ data['related'][nro].smd.title }}</a>
      &ensp;
    </td>
    <td>
      <img src="/static/img/blue.png" width="{{ (s*300) | int }}" height="10">
      &ensp;<small>{{ (s*100) | int }} %&emsp;</small>
    </td>
    <td>
      <small>{{ data['related'][nro].smd.year }}</small>
    </td>
    <td>
      <small>{{ data['related'][nro].smd.location }}</small>
    </td>
    <td>
      <small>{{ data['related'][nro].smd.collector }}</small>
    </td>
  </tr>
  {% endfor %}
</table>

{% if data['sim_left'] %}
<h2>Contained in poems</h2>
<p><small>[<a href="/multidiff?nro={{ data['poem'].nro }},{{ data['sim_left'] | map(attribute=0) | join(',') }}">compare all</a>]</small></p>
{% endif %}

<table style="user-select: none">
{% for nro, s in data['sim_left'] | sort(attribute=1, reverse=True) %}
  <tr>
    <td align="right" class="poem_id">
    <a href="/poemdiff?nro1={{ data['poem'].nro }}&nro2={{ nro }}">{{ data['related'][nro].smd.title }}</a>
      &ensp;
    </td>
    <td>
      <img src="/static/img/blue.png" width="{{ (s*300) | int }}" height="10">
      &ensp;<small>{{ (s*100) | int }} %&emsp;</small>
    </td>
    <td>
      <small>{{ data['related'][nro].smd.year }}</small>
    </td>
    <td>
      <small>{{ data['related'][nro].smd.location }}</small>
    </td>
    <td>
      <small>{{ data['related'][nro].smd.collector }}</small>
    </td>
  </tr>
  {% endfor %}
</table>

<h2>Text</h2>

<p><small>
{% if args['show_verse_themes'] %}[<a href="{{ links['-show_verse_themes'] }}">hide verse-level themes</a>]
{% else %}
[<a href="{{ links['+show_verse_themes'] }}">show verse-level themes</a>]
{% endif %}
{% if args['show_shared_verses'] %}[<a href="{{ links['-show_shared_verses'] }}">hide shared verses matrix</a>]
{% else %}
[<a href="{{ links['+show_shared_verses'] }}">show shared verses matrix</a>]
{% endif %}
</small></p>
{% if args['show_shared_verses'] %}
<p>
    Showing top {{ data['linked_poems'] | length }}
    (<a href="{{ links['-max_similar'] }}">-10</a>/<a href="{{ links['+max_similar'] }}">+10</a>) out of {{ data['poems_sharing_verses'] }} poems sharing verses with this one based on the number of shared [
{% if args['sim_order']=="consecutive_rare" %}
    consecutive rare
{% else %}<a href="{{ links['sim_order:consecutive_rare'] }}">consecutive rare</a>
{% endif %}
    /
{% if args['sim_order']=="consecutive" %} consecutive
{% else %}<a href="{{ links['sim_order:consecutive'] }}">consecutive</a>
{% endif %}
    /
{% if args['sim_order']=="rare" %} rare
{% else %}<a href="{{ links['sim_order:rare'] }}">rare</a>
{% endif %}
    /
{% if args['sim_order']=="shared" %} any
{% else %}<a href="{{ links['sim_oder:any'] }}">any</a>
{% endif %}
    ] verses
</p>
{% endif %}
{% if args['show_verse_themes'] %}
<p><b>Note:</b> Verse-level theme recognition is done using an experimental
method and the quality of the results is not yet known.
</p>
{% endif %}
<table cellspacing="0" cellpadding="2">
  {% for v in data['poem'].text %}
  <tr>
    {% if args['show_verse_themes'] %}
      {% if v.pos-1 in data['verse_themes'] %}
      <td rowspan={{ data['verse_themes'][v.pos-1][0] }} class="g{{ data['verse_themes'][v.pos-1][2] % 2 }}">
        {{ data['verse_themes'][v.pos-1][1] }}
      </td>
      {% endif %}
    {% endif %}
    {% if v.v_type == "V" %}
      <td bgcolor="{{ data['colors'][v.clust_freq] }}">
        <a name="{{ v.pos }}" href="/verse?nro={{ data['poem'].nro }}&pos={{ v.pos }}" title="{{ v.clust_freq }}" class="cn">&nbsp;&nbsp;&nbsp;
        </a>
      </td>
      <td align="right" width="35" class="verse_id" id="{{ v.pos }}">&ensp;<sup><small>{{ v.pos }}</small></sup></td>
      <td width="350">
      {% if v.pos in args['hl'] %}
        <b>{{ v.text }}</b>
      {% else %}
        {{ v.text }}
      {% endif %}</td>
      <!-- TODO consider: showing the blue bar again on the right? -->
      <!--
      <td bgcolor="{{ v[2] }}">
        <a name="{{ v[0] }}" href="/verse?nro={{ data['poem'].smd.nro }}&pos={{ v[0] }}" title="{{ v[1] }}" class="cn">&nbsp;&nbsp;&nbsp;
        </a>
      </td> -->
    {% else %}
      {% if v.v_type == "L" %}
      <td></td><td></td><td><small><i>{{ v.text }}</i></small></td><!-- <td></td> -->
      {% elif v.v_type == "K" %}
      <td></td><td></td><td><small>{{ v.text }}</small></td><!-- <td></td> -->
      {% elif v.v_type == "CPT" %}
      <!-- <td colspan="4" align="center">-->
      <td></td><td></td><td align="center">
        <h4>{{ v.text }}</h4>
      </td>
      {% endif %}
    {% endif %}
    <td>
    {% if args['show_shared_verses'] %}
    {% for p2 in data['linked_poems'] %}
        {% if v.clust_id in data['verse_poems'] and p2 in data['verse_poems'][v.clust_id] %}
            <a href="/poemdiff?nro1={{ data['poem'].nro }}&nro2={{ p2 }}" class="c{{ loop.index % 13}}" title="{{ p2 }}">&nbsp;&nbsp;&nbsp;</a>
        {% else %}
            <span class="cn">&nbsp;&nbsp;&nbsp;</span>
        {% endif %}
    {%  endfor %}
    {% endif %}
    </td>
  </tr>
  {% endfor %}
  <tr><td colspan="5"><hr/></td></tr>
  <tr><td></td><td></td>
    <td colspan="3" style="word-wrap: break-word; max-width: 500px">
    <small>
    {% for r in data['poem'].refs %}
    {{ r }}<br/>
    {% endfor %}
    </small>
  </td></tr>
</table>

<script lang="javascript">
  const ds = new Selection({
    selectables: '.verse_id'
  })
  function getTableCell(node) {
    var n = node;
    while (n.tagName != "TD" && n.parentNode) {
      n = n.parentNode;
    }
    if (n.tagName == "TD") {
      return n;
    } else {
      return null;
    }
  }
  ds.on('beforestart', (evt) => {
    console.log(evt);
    var c = getTableCell(evt.oe.target);
    return (c !== null && c.className == "verse_id");
  });
  ds.on('move', ({ changed: { removed, added } }) => {
      for (const el of added)
        getTableCell(el).classList.add('selected')
      for (const el of removed)
        getTableCell(el).classList.remove('selected')
    })
  ds.on('stop', ({inst,selected}) => {
    inst.clearSelection()
    for (const el of selected) {
      getTableCell(el).classList.remove('selected')
    }
    window.open('/passage?nro={{ data['poem'].nro }}&start=' + selected[0].id + '&end=' + selected[selected.length - 1].id,'_self')
  })
</script>

</body>
</html>
